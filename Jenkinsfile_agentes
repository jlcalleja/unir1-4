pipeline {
    agent any
    options {
        skipDefaultCheckout true // Evita el checkout automático en nodos esclavos
    }

    stages {
        stage('Get Code') {
            steps {
                git url: 'https://github.com/jlcalleja/unir1-4', branch: 'develop', credentialsId: '4d4a1cc8-ee35-4ff6-8837-90699db6e6f7'
                
                stash includes: '**', name: 'codigo' 
            }
        }
        
        stage('Static Test') {
            agent { label 'user1' }
            steps {
                unstash 'codigo'
                
                sh 'flake8 src/ > flake8_report.txt || true'
                sh 'bandit -r src/ -f html -o bandit_report.html || true'
            }
        }

        stage('SAM Deploy') {
            steps {
                sh 'sam build'
                sh '''
                    sam deploy --no-confirm-changeset \
                        --no-fail-on-empty-changeset \
                        --stack-name todo-list-aws-staging \
                        --resolve-s3 \
                        --parameter-overrides Stage=staging
                '''
            }
        }

        stage('Get API URL') {
            steps {
                script {
                    // Obtener el valor de BASE_URL desde CloudFormation
                    def baseUrlCommand = "aws cloudformation describe-stacks --stack-name todo-list-aws-staging --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' --region us-east-1 --output text"
                    env.BASE_URL = sh(script: baseUrlCommand, returnStdout: true).trim()
                    echo "BASE_URL: ${env.BASE_URL}"
                    
                    stash includes: '**', name: 'url' 
                }
            }
        }

        stage('Test Rest') {
            agent { label 'user2' }
            steps {
                script {
                    unstash 'codigo'
                    unstash 'url'

                    if (!env.BASE_URL?.trim()) {
                        error "BASE_URL is empty or undefined. Cannot proceed with API tests."
                    }
                    sh "BASE_URL=${env.BASE_URL} pytest test/integration/todoApiTest.py"
                }
            }
        }

        stage('Promote') {
            steps {
                script {
                    // Configurar nombre de usuario para Git
                    sh "git config --global user.name 'JLC'"
                    
                    // Asegurarse de estar en la rama correcta
                    sh 'git checkout develop'
                    sh 'git checkout master'
                    sh 'git pull origin master'

                    // Realizar el merge desde 'develop' a 'master'
                    def mergeResult = sh(script: 'git merge develop', returnStatus: true)
                    
                    if (mergeResult != 0) {
                        echo "Merge conflict detected, proceeding to resolve..."
                        
                        // Resolver el conflicto: Mantener la versión de 'master' para Jenkinsfile y Jenkinsfile_agentes
                        sh 'git checkout --ours Jenkinsfile'
                        sh 'git checkout --ours Jenkinsfile_agentes'
                        sh 'git add Jenkinsfile Jenkinsfile_agentes'
                        sh 'git commit -m "Resolved merge conflict: keeping Jenkinsfile and Jenkinsfile_agentes from master"'
                    }
        
                    // Usar las credenciales de tipo 'Username with password' directamente
                    withCredentials([usernamePassword(credentialsId: '4d4a1cc8-ee35-4ff6-8837-90699db6e6f7', usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_TOKEN')]) {
                        // Hacer el git push con el nombre de usuario y el token
                        sh "git push https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/jlcalleja/unir1-4.git master"
                    }
                }
            }
        }
    }
    
    post {
        always {
            node('user1') {
                cleanWs() 
            }
            node('user2') {
                cleanWs() 
            }
        }
    }
}
